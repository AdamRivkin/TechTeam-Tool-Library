<script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>
<script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB8hoMNt7re3XiQdBmYDg1IhwUJTfuk7qA&callback=initMap&libraries=&v=weekly"
      defer
    ></script>
<script>
    var firebaseConfig = {
      apiKey: "AIzaSyA6b8VI6bMip3f91qVgj6JYfiWaKPdXnp0",
      authDomain: "ctl-prac.firebaseapp.com",
      databaseURL: "https://ctl-prac.firebaseio.com",
      projectId: "ctl-prac",
      storageBucket: "ctl-prac.appspot.com",
      messagingSenderId: "300403040266",
      appId: "1:300403040266:web:b0642a81fea48247e0bff3",
      measurementId: "G-TEVE4LG3X6"
    };
    firebase.initializeApp(firebaseConfig);
    
    var legend = {
      "Bikes" : "transportation",
      "Cars" : "transportation",
      "Camping" : "environment",
      "Composting" : "environment",
      "Community, Art, and Event Spaces" : "creative",
      "Leather Arts" : "creative",
      "Printmaking" : "creative",
      "Weaving" : "creative",
      "Computers and Tech" : "technology",
      "Construction" : "construction",
      "Makerspaces" : "construction",
      "Reclaimed Materials" : "construction",
      "Repair Events" : "construction",
      "Tool Libraries" : "construction",
      "Welding" : "construction",
      "Woodworking" : "construction"
    };
    
    function getLegend(category){
      if(legend[category] == null){
          return ""
      } else {
          return legend[category];
      }
    }
    
    function addCard(category, resource_name, resource){
      var newCard = '<div class="resource-card"><b>' + resource_name + '</b><br>'
      newCard += '<span class="tag ' + getLegend(category) + '">' + category + '</span>'
      if(resource["address"] != null){
          newCard += '<div class="location"><img src="https://cdn.iconscout.com/icon/free/png-256/location-pin-4-458123.png" class="mini-icon" alt="circle image"/>' + resource["address"] + '</div>';
      }
      if(resource["website"] != null){
          newCard += '<img src="https://img.pngio.com/free-png-website-icons-konfest-website-icons-png-2000_2000.png" class="mini-icon" alt="circle image"/> <a class="website-link" href="' + resource["website"] + '">' + resource["website"] + '</a>';
      }
      if(resource["contact number"] != null){
          newCard += '<div class="phone"> <img src="https://img.icons8.com/ios/452/phone.png" class="mini-icon" alt="circle image"/>' + resource["contact number"] + '</div>'
      }
      newCard += "</div>";
      document.getElementById('search-results').innerHTML += newCard;
    }
    
    var all_resources = {};
    
    function prepareCards(resources_object){
      document.getElementById('search-results').innerHTML = "";
      for (const [category, resources] of Object.entries(resources_object)) {
        for(const [resource_name, resource] of Object.entries(resources)){
          addCard(category, resource_name, resource);
        }
      }
    }
    
    var database = firebase.database();
    database.ref('/').once('value').then(function(snapshot) {
    	all_resources = snapshot.val();
      prepareCards(all_resources);
    });
    
    function filterResults(){
      var search_name = document.getElementById('search-input').value;
      var current_resources = {};
      for (const [category, resources] of Object.entries(all_resources)) {
        for(const [resource_name, resource] of Object.entries(resources)){
          if(resource_name.toLowerCase().includes(search_name.toLowerCase()) || category.toLowerCase().includes(search_name.toLowerCase())){
            if(current_resources[category] == null){
              current_resources[category] = {};
            }
            current_resources[category][resource_name] = resource;
          }
        }
      }
      console.log(current_resources);
      prepareCards(current_resources);
    }
    
    function initMap() {
      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 8,
        center: { lat: 40.72, lng: -73.96 },
      });
      const geocoder = new google.maps.Geocoder();
      const infowindow = new google.maps.InfoWindow();
      document.getElementById("submit").addEventListener("click", () => {
        geocodePlaceId(geocoder, map, infowindow);
      });
      
      function codeAddress(geocoder, map) {
        geocoder.geocode({'address': address}, function(results, status) {
          if (status === 'OK') {
            map.setCenter(results[0].geometry.location);
            var marker = new google.maps.Marker({
              map: map,
              position: results[0].geometry.location
            });
          } else {
            alert('Geocode was not successful for the following reason: ' + status);
          }
        });
      
    }

    // This function is called when the user clicks the UI button requesting
    // a geocode of a place ID.
    function geocodePlaceId(geocoder, map, infowindow) {
      const placeId = document.getElementById("place-id").value;
      geocoder.geocode({ placeId: placeId }, (results, status) => {
        if (status === "OK") {
          if (results[0]) {
            map.setZoom(11);
            map.setCenter(results[0].geometry.location);
            const marker = new google.maps.Marker({
              map,
              position: results[0].geometry.location,
            });
            infowindow.setContent(results[0].formatted_address);
            infowindow.open(map, marker);
          } else {
            window.alert("No results found");
          }
        } else {
          window.alert("Geocoder failed due to: " + status);
        }
      });
    }
</script>


<style>
  .resource-card {
    background-color: white;
    box-shadow: 0px 4px 4px rgba(0, 0, 0, 0.25);
    padding-right: 8%;
    padding-left: 8%;
    padding-top: 10px;
    padding-bottom: 10px;
    margin-bottom: 10px;
  }
  #search-container{
    background-color: white;
    padding: 15px;
    height: 1000px;
    overflow-y: scroll;
  }
  .results-text{
    font-size: 20px;
  }
  .transportation{
    background-color: #EF453F;
  }
  .construction{
    background-color: #1980A1;
  }
  .environment{
    background-color: #72C8AD;
  }
  .creative{
    background-color: #F5714E;
  }
  .technology{
    background-color: #372E32;
  }
  .tag{
    border-radius: 25px;
    color: white;
    font-size: 14px;
    padding-top: 5px;
    padding-bottom: 5px;
    padding-right: 10px;
    padding-left: 10px;
    margin-bottom: 5px;
  }
  .location{
    font-size: 15px;
  }
  .times{
    font-size: 15px;
  }
  .website-link{
    font-size: 15px;
  }
  .phone{
    font-size: 15px;
  }
  .mini-icon{
    width: 20px;
    height:20px;
  }
  #search-button{
    background-color:#372E32;
    color:white;
    border-radius: 5px;
  }
  #search-input{
    width:90%;
    background-color:#E5E5E5;
    border-radius:5px;
    border-width:0px;
    color: #000000;
  }
  
  #search-input:focus {
    outline: none;
  }
</style>
